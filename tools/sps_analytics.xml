<?xml version="1.0" encoding="UTF-8"?>

<tool type="plugin">

    <src>
        <![CDATA[

        var sessionsInfoListener = spm.addListener('SPATIALMAP_READY', data => {
            let sessionsinfoDs = spm.getSession().getDatasource('sps_session_info')
            let ad_object = spm.getSession().getPrincipal().id
            let ad_object_filterRegex = /CN=.*?(?=(OU=|DC=))/g
            let ad_objectFiltered = ad_object.replace(ad_object_filterRegex, '')

            let afdelingsRegex = /OU=([^,\\]+(?:\\, [^,\\]+)*)(?:,OU=|,DC=|$)/;
            let regexMatch = ad_objectFiltered.match(afdelingsRegex)

            let afdeling = regexMatch[1].replace(/\\,/g, ',')

            sessionsinfoDs.execute({
                command: 'insert-session-info',
                session_id: spm.getSessionId(),
                afdeling: afdeling,
                ad_object: ad_objectFiltered,
                site: window.location.host,
                profile: spm.getProfile()
            })
        })
        
        var themeListener = spm.addListener('THEME_VISIBILITY_CHANGED', function(eventname, data, visible) {
            if (eventname == 'THEME_VISIBILITY_CHANGED' && visible) {
                let analyticsDs = spm.getSession().getDatasource('sps_analytics')

                analyticsDs.execute({
                    command: 'insert-theme-interaction',
                    sessionid: spm.getSessionId(),
                    themename: data.name,
                    displayname: data._displayname,
                    datasourcename: data._initialConfig.primarydatasource,
                    site: window.location.host,
                    profile: spm.getProfile(),
                    site: window.location.host,
                    profile: spm.getProfile()
                })
            }
        })

        var searchresultListener = spm.addListener('SEARCH_RESULT_SELECTED', function(eventname, data) {
            let analyticsDs = spm.getSession().getDatasource('sps_analytics')
            analyticsDs.execute({
                command: 'insert-search-result',
                sessionid: spm.getSessionId(),
                service: data.service,
                title: data.title,
                text: data.text,
                wkt: data.wkt,
                site: window.location.host,
                profile: spm.getProfile()
            })
        })
        
        var buttonListener = spm.addListener('BUTTON_CLICKED', function(eventname, button) {
            if (button.type == 'button' || (button.type == 'menu' && button._state)) {
                let analyticsDs = spm.getSession().getDatasource('sps_analytics')
                analyticsDs.execute({
                    command: 'insert-button-click',
                    sessionid: spm.getSessionId(),
                    displayname: button.displayname,
                    buttonname: button.name,
                    buttontype: button.type,
                    site: window.location.host,
                    profile: spm.getProfile()
                })
            }
        })]]>
    </src>
</tool>